<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>æ¯æ—¥é”€å”®è®°å½•ç³»ç»Ÿ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body { font-family: sans-serif; background: #f9f9f9; display: flex; justify-content: center; }
    .container { width: 90%; max-width: 1000px; background: #fff; padding: 20px; margin-top: 20px; border-radius: 10px; box-shadow: 0 0 10px #ccc; text-align: center; }
    h1 { color: darkred; margin-bottom: 0; }
    h2 { color: green; font-size: 2rem; margin-top: 5px; display: flex; justify-content: center; align-items: center; }
    h2::before { content: "ğŸŒ¿ "; margin-right: 6px; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; display: none; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: right; }
    th { background: #eee; }
    .summary, .total { margin-top: 15px; font-weight: bold; color: darkred; display: flex; justify-content: space-around; gap: 10%; }
    .total { color: red; }
    .btn-bar { text-align: center; margin: 15px 0; }
    button { margin: 8px; padding: 10px 20px; font-size: 1.1rem; }
    input[type="text"], select, input[type="date"] { font-size: 1.1rem; padding: 6px; text-align: right; }
  </style>
</head>
<body>
  <div class="container">
    <h1>æ¯æ—¥é”€å”®è®°å½•ç³»ç»Ÿ</h1>
    <h2 id="companyTitle">Lover Legend Gardening</h2>

    <div class="btn-bar">
      <button onclick="switchCompany()">åˆ‡æ¢å…¬å¸</button>
    </div>

    <div>
      <label>æ—¥æœŸï¼š</label>
      <input type="date" id="date"><br/>
      <label>é”€å”®é¢ï¼ˆRMï¼‰ï¼š</label>
      <input type="text" id="sales" value="0.00">
      <button onclick="submitData('sales')">æäº¤</button>
      <button onclick="modifyData('sales')">ä¿®æ”¹</button><br/>
      <label>è´¹ç”¨ï¼ˆRMï¼‰ï¼š</label>
      <input type="text" id="cost" value="0.00">
      <select id="cost-type">
        <option value="æ‚è´¹">æ‚è´¹</option>
        <option value="è–ªæ°´">è–ªæ°´</option>
      </select>
      <button onclick="submitData('cost')">æäº¤</button>
      <button onclick="modifyData('cost')">ä¿®æ”¹</button>
    </div>

    <div class="summary">
      <div id="summary-sale"></div>
      <div id="summary-cost"></div>
    </div>

    <div class="total">
      <div id="total-sale"></div>
      <div id="total-cost"></div>
    </div>

    <button onclick="toggleTable()">æ˜¾ç¤º / éšè—æ˜ç»†</button>
    <button onclick="exportToExcel()">å¯¼å‡ºä¸º CSV</button>
    <label><button onclick="document.getElementById('fileInput').click()">Restore Excel</button><input id="fileInput" type="file" accept=".csv" onchange="importFromCSV(event)" style="display:none;"></label>
    <button onclick="syncToGoogleSheet()">å†™å…¥ Google è¡¨æ ¼</button>

    <table id="data-table">
      <thead><tr><th>æ—¥æœŸ</th><th>é”€å”®é¢</th><th>è´¹ç”¨</th></tr></thead>
      <tbody id="table-body"></tbody>
    </table>
  </div>

<script>
  // ä¸å‰é¢ç›¸åŒçš„é€»è¾‘åˆå§‹åŒ– data ä¸ render ç­‰å‡½æ•°
  const format = val => parseFloat(val || 0).toLocaleString('en-MY', { style: 'decimal', minimumFractionDigits: 2 });
  const cached = localStorage.getItem("bonsai_data");
  const data = cached ? JSON.parse(cached) : { adenium: {}, gardening: {} };
  let current = "gardening";

  document.getElementById("date").valueAsDate = new Date();

  function switchCompany() {
    current = current === 'adenium' ? 'gardening' : 'adenium';
    document.getElementById("companyTitle").innerText = current === 'adenium' ? 'Lover Legend Adenium' : 'Lover Legend Gardening';
    render();
    document.getElementById("sales").value = "0.00";
    document.getElementById("cost").value = "0.00";
  }

  function submitData(type) {
    const date = document.getElementById("date").value;
    if (!data[current][date]) data[current][date] = { sales: 0, cost: { amount: 0, type: "æ‚è´¹" } };
    if (type === 'cost') {
      if (data[current][date].cost.amount !== 0) return alert("å·²æœ‰äººè®°å½•ï¼Œä¸èƒ½è¦†ç›–ï¼Œè¯·ç”¨ä¿®æ”¹");
      const val = document.getElementById(type).value.replace(/,/g, '');
      const costType = document.getElementById("cost-type").value;
      data[current][date][type] = { amount: parseFloat(val), type: costType };
    } else {
      if (data[current][date][type] !== 0) return alert("å·²æœ‰äººè®°å½•ï¼Œä¸èƒ½è¦†ç›–ï¼Œè¯·ç”¨ä¿®æ”¹");
      const val = document.getElementById(type).value.replace(/,/g, '');
      data[current][date][type] = parseFloat(val);
    }
    render();
  }

  function modifyData(type) {
    const date = document.getElementById("date").value;
    if (!data[current][date]) data[current][date] = { sales: 0, cost: { amount: 0, type: "æ‚è´¹" } };
    const val = document.getElementById(type).value.replace(/,/g, '');
    if (type === 'cost') {
      const costType = document.getElementById("cost-type").value;
      data[current][date][type] = { amount: parseFloat(val), type: costType };
    } else {
      data[current][date][type] = parseFloat(val);
    }
    render();
  }

  function render() {
    let totalSales = 0, totalCost = 0, rows = '';
    for (const d in data[current]) {
      const s = data[current][d].sales, c = data[current][d].cost.amount;
      const t = data[current][d].cost.type;
      totalSales += s; totalCost += c;
      rows += `<tr><td>${d}</td><td>RM ${format(s)}</td><td>RM ${format(c)}ï¼ˆ${t}ï¼‰</td></tr>`;
    }
    document.getElementById("summary-sale").innerText = `é”€å”®é¢ï¼šRM ${format(totalSales)}`;
    document.getElementById("summary-cost").innerText = `è´¹ç”¨ï¼šRM ${format(totalCost)}`;

    let overallSales = 0, overallCost = 0;
    for (const company in data) {
      for (const d in data[company]) {
        overallSales += data[company][d].sales;
        overallCost += data[company][d].cost.amount;
      }
    }
    document.getElementById("total-sale").innerText = `æ€»é”€å”®ï¼ˆä¸¤é—´å…¬å¸ï¼‰ï¼šRM ${format(overallSales)}`;
    document.getElementById("total-cost").innerText = `æ€»è´¹ç”¨ï¼šRM ${format(overallCost)}`;
    document.getElementById("table-body").innerHTML = rows;
    localStorage.setItem("bonsai_data", JSON.stringify(data));
  }

  function toggleTable() {
    const table = document.getElementById("data-table");
    table.style.display = table.style.display === "none" ? "table" : "none";
  }

  function exportToExcel() {
    let rows = [["å…¬å¸", "æ—¥æœŸ", "é”€å”®é¢ (RM)", "è´¹ç”¨ (RM)", "ç±»å‹"]];
    for (const company in data) {
      for (const d in data[company]) {
        const s = data[company][d].sales.toFixed(2);
        const c = data[company][d].cost.amount.toFixed(2);
        const t = data[company][d].cost.type;
        rows.push([company, d, s, c, t]);
      }
    }
    const csv = rows.map(e => e.join(",")).join("\n");
    const blob = new Blob(["\uFEFF" + csv], { type: "text/csv;charset=utf-8;" });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "é”€å”®è®°å½•.csv";
    link.click();
  }

  function importFromCSV(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
      const lines = e.target.result.split("\n").filter(line => line.trim());
      const headers = lines.shift().split(",");
      const newData = { adenium: {}, gardening: {} };
      for (const line of lines) {
        const [company, date, sales, cost, type] = line.split(",");
        if (!company || !date || isNaN(sales)) continue;
        if (!newData[company]) newData[company] = {};
        newData[company][date] = {
          sales: parseFloat(sales),
          cost: { amount: parseFloat(cost), type: (type || "æ‚è´¹").replace(/\r/g, "").trim() }
        };
      }
      Object.assign(data.adenium, newData.adenium);
      Object.assign(data.gardening, newData.gardening);
      render();
    };
    reader.readAsText(file, "utf-8");
  }

  render();
</script>
</body>
</html>
